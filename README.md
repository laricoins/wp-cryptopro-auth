# CryptoPro Auth for WP

Плагин для авторизации на сайте WordPress с использованием электронной цифровой подписи (ЭЦП) КриптоПро.

## Описание

Плагин позволяет пользователям входить на сайт, используя сертификаты ЭЦП КриптоПро. Поддерживается автоматическая регистрация новых пользователей по данным из сертификата.

**Основные возможности:**
*   Авторизация по ЭЦП (ГОСТ).
*   Автоматическая регистрация пользователей.
*   Поддержка PHP-расширения `php-cades` для проверки подписи на сервере.
*   Режим совместимости (упрощенная проверка) при отсутствии расширения.
*   **Безопасность:** Whitelist доверенных УЦ, логирование попыток входа, поддержка HTTPS, CORS.

## Требования

1.  **На сервере:**
    *   WordPress 5.0 или выше.
    *   PHP 7.2 или выше.
    *   Рекомендуется наличие PHP-расширения для работы с КриптоПро (например, `php-cades`), но плагин имеет режим совместимости и без него (с ограниченной проверкой).
    *   **SSL сертификат (HTTPS)** - настоятельно рекомендуется для безопасности.

2.  **На клиенте (у пользователя):**
    *   КриптоПро CSP.
    *   КриптоПро Browser Plugin.
    *   Действующий личный сертификат ЭЦП.

## Установка

1.  Загрузите папку плагина `wp-cryptopro-auth` в директорию `/wp-content/plugins/`.
2.  Активируйте плагин через меню "Плагины" в WordPress.
3.  Перейдите в настройки: **Настройки -> CryptoPro Auth**.

## Настройки

В админ-панели доступны следующие настройки:

### Основные
*   **API Endpoint**: URL для внешней проверки подписи (если не используется локальное PHP-расширение).
*   **Автосоздание пользователей**: Если включено, новые пользователи будут автоматически регистрироваться при первом входе.
*   **Роль по умолчанию**: Роль, которая будет назначена новым пользователям (например, `subscriber`).
*   **Режим отладки**: Включает вывод технической информации в консоль браузера и на странице диагностики.
    *   *Кеширование*: В режиме отладки скрипты и стили загружаются со случайной версией для сброса браузерного кеша. В обычном режиме используется версия плагина.
*   **Тест-режим**: Позволяет тестировать процесс входа без реальной проверки криптографической подписи (ВНИМАНИЕ: Не использовать на боевом сайте!).

### Безопасность
*   **Доверенные УЦ (Whitelist)**: Список издателей сертификатов, которым разрешен вход. Позволяет ограничить доступ только сотрудникам определенных организаций (например, ФНС).
    
    **Как работает Whitelist (Доверенные УЦ):**
    Вы вводите в настройках ключевые фразы, по одной на строку. Плагин проверяет поле Issuer (Издатель) сертификата. Если хотя бы одна из ваших фраз содержится в строке издателя, сертификат считается доверенным.

    *Пример:* В настройках вы указали:
    > Федеральная налоговая служба
    > Тензор

    *   Сертификат А: Издатель `CN=Федеральная налоговая служба, O=Федеральная налоговая служба...` -> **ДОСТУП РАЗРЕШЕН** (найдено совпадение "Федеральная налоговая служба").
    *   Сертификат Б: Издатель `CN=ООО "Компания Тензор", O=ООО "Компания Тензор"...` -> **ДОСТУП РАЗРЕШЕН** (найдено совпадение "Тензор").
    *   Сертификат В: Издатель `CN=GlobalSign, O=GlobalSign nv-sa...` -> **ДОСТУП ЗАПРЕЩЕН** (совпадений нет).
*   **Логирование**: Запись всех попыток входа (успешных и неудачных) в лог-файл.
    *   *Безопасность*: Логи защищены от прямого доступа через веб (автоматически создается `.htaccess`).
    *   *Ротация*: Включена автоматическая ротация логов (хранится до 5 файлов по 100 КБ), чтобы предотвратить переполнение диска.
*   **Требовать HTTPS**: Запрещает авторизацию по незащищенному протоколу HTTP.
*   **Настройки CORS**: Управление заголовками Cross-Origin Resource Sharing для API авторизации.

## Шорткоды

Плагин предоставляет шорткоды для размещения элементов авторизации на страницах сайта:

### `[cryptopro_login]`
Выводит кнопку "Войти с помощью КриптоПро".
**Примечание:** Если пользователь уже авторизован, вместо кнопки будет выведено сообщение: "Имя пользователя, вы уже залогинены".

**Параметры:**
*   `button_text` — Текст на кнопке (по умолчанию: "Войти с помощью КриптоПро").
*   `show_guide` — Показать краткую инструкцию под кнопкой (`true`/`false`, по умолчанию: `true`).
*   `class` — CSS класс контейнера.

**Пример:**
```
[cryptopro_login button_text="Вход по ЭЦП" show_guide="false"]
```

### `[cryptopro_auth]`
Выводит полноценный блок авторизации с заголовком и описанием.
**Примечание:** Если пользователь уже авторизован, заголовок и описание скрываются, и выводится только сообщение о том, что пользователь уже вошел в систему.

**Параметры:**
*   `title` — Заголовок блока.
*   `description` — Описание.
*   `redirect` — URL для перенаправления после входа.

**Пример:**
```
[cryptopro_auth title="Личный кабинет" description="Пожалуйста, авторизуйтесь"]
```

### `[cryptopro_debug]`
Выводит диагностическую информацию о системе и плагине. Виден только администраторам.

## Хуки для разработчиков

*   `cryptopro_user_authenticated` (`$user_id`, `$cert_data`) — Срабатывает после успешной авторизации.
*   `cryptopro_user_created` (`$user_id`, `$cert_data`) — Срабатывает после регистрации нового пользователя.

## Структура плагина

*   `cryptopro-auth.php` — Основной файл.
*   `includes/` — Логика работы (аутентификация, валидация, шорткоды, админка, AJAX).
*   `templates/` — HTML-шаблоны.
*   `assets/` — JS скрипты и стили.

## Благодарности

Выражаем благодарность компании [КриптоПро](https://cryptopro.ru) и её разработчикам за консультации и помощь в реализации интеграции.

## Контакты

По вопросам обращайтесь в Telegram: **@ddnitecry**
